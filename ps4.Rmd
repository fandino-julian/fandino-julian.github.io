---
title: "Problem set 4"
author: "JULIAN FANDIÑO_202021070"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
# Configuración del entorno
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(pacman)
p_load(rio, data.table, tidyverse, sf, rvest, ggplot2, viridis, rmarkdown)
```


```{r, eval=TRUE, echo=TRUE, message=FALSE, results='hide'}
# 1.1 Extracción de URLs de la página web
url <- "https://eduard-martinez.github.io/pset-4.html"
webpage <- read_html(url)
url_full <- webpage %>% html_nodes("a") %>% html_attr("href") %>% na.omit() %>% unique()

# 1.2 Filtrar URLs que contienen la palabra "propiedad"
url_subset <- url_full[grepl("propiedad", url_full)]
url_subset
```

```{r,eval=TRUE,echo=TRUE,message=FALSE}
# 1.3 Extracción de las tablas de las URLs filtradas
lista_tablas <- lapply(url_subset, function(link) {
  page <- read_html(link)
  table <- page %>% html_table(fill = TRUE) %>% .[[1]]
  return(table)
})
# 1.4 Combinar las tablas en un solo dataframe
db_house <- rbindlist(lista_tablas, fill = TRUE)
colnames(db_house) <- make.names(colnames(db_house), unique = TRUE)

## Mostrar las primeras filas del dataframe
head(db_house)
## Convertir las columnas lat y lon a valores numéricos
db_house <- db_house %>%
  mutate(lat = as.numeric(lat), lon = as.numeric(lon))

# 2.1 Crear un objeto sf a partir del dataframe
sf_house <- st_as_sf(db_house, coords = c("lon", "lat"), crs = 4326)

# 2.2 Crear un mapa con ggplot2
mapa <- ggplot() +
  geom_sf(data = sf_house, aes(color = price), size = 2) +
  scale_color_viridis() +
  theme_minimal() +
  labs(title = "Mapa de Propiedades", color = "Precio")

## Mostrar el mapa
mapa

## Guardar el mapa como un archivo PDF
ggsave("mapa_propiedades.pdf", mapa)